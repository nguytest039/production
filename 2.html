<!-- <%@ page contentType="text/html;charset=UTF-8" language="java" %> -->
<!-- <link rel="stylesheet" href="/production-system/assets/plugins/daterangepicker/daterangepicker.css" />
<script src="/production-system/assets/plugins/jquery/jquery.min.js"></script>
<script src="/production-system/assets/plugins/daterangepicker/moment.min.js"></script>
<script src="/production-system/assets/plugins/daterangepicker/daterangepicker.js"></script> -->
<script src="https://code.highcharts.com/highcharts.js"></script>

<link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous" />
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
<style>
    .component-wrapper {
        /* border: 1px solid green; */
        padding: 0.35rem 0.35rem;
    }

    .component-item {
        height: 100%;
        padding: 0.5rem 0.75rem;
        background-color: rgba(73, 146, 255, 0.15);
        box-shadow: 0 3px 17px #030616;
        border-radius: 0.3rem;
        overflow: hidden;
        display: flex;
        justify-content: flex-start;
        flex-direction: column;
        -webkit-border-radius: 0.3rem;
        -moz-border-radius: 0.3rem;
        -ms-border-radius: 0.3rem;
        -o-border-radius: 0.3rem;
    }

    .component-item .chart-box {
        height: 28vh;
    }

    .component-item .chart-box > div {
        width: 100% !important;
        height: 100% !important;
    }

    .component-item .table-box {
        height: 25vh;
        overflow-y: auto;
        overflow-x: auto;
    }

    .component-item .info-box {
        height: 6vh;
        background-color: rgba(73, 146, 255, 0.15);
    }

    .component-title {
        font-size: 1.12rem;
        margin: 0;
        padding-bottom: 0.5rem;
    }

    .text-span {
        font-size: 1.12rem;
    }

    .table-responsive::-webkit-scrollbar,
    .component-item .table-box::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .table-responsive::-webkit-scrollbar-thumb,
    .component-item .table-box::-webkit-scrollbar-thumb {
        background-color: #264b8b;
        border-radius: 3px;
    }

    .table-responsive::-webkit-scrollbar-track,
    .component-item .table-box::-webkit-scrollbar-track {
        background-color: rgba(73, 146, 255, 0.1);
        border-radius: 3px;
    }

    .table-responsive::-webkit-scrollbar-corner,
    .component-item .table-box::-webkit-scrollbar-corner {
        background-color: rgba(73, 146, 255, 0.1);
    }

    .table {
        --border-color: #6290b5;
        margin-bottom: 0;
        border-right: 1px solid #37567f;
        border-top: 1px solid #37567f;
    }

    .table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table th,
    .table td {
        text-align: center;
        vertical-align: middle;
        color: #fff;
        border: none;
        box-shadow: inset 0.5px -0.5px 0px var(--border-color);
        font-weight: normal;
        line-height: 1.2;
    }

    .table thead th {
        font-size: 0.9rem;
        background-color: #264b8b;
        font-size: 0.9rem;
    }

    .table tbody td {
        font-size: 0.8rem;
        background-color: transparent;
    }
    /* 
.table-striped > tbody > tr:nth-of-type(odd) > * {
    background-color: #264e9256;
} */

    .table-striped > tbody > tr.odd {
        background-color: #264e9256;
    }

    .table tbody td.grand-value {
        /* color: #5e9fff; */
        color: #03a9f4;
    }

    select[name="sl-option"] {
        cursor: pointer;
    }

    select[name="sl-option"]:focus,
    select[name="sl-option"]:focus-visible {
        outline: 0;
        box-shadow: none;
    }

    select[name="sl-option"] option {
        background: #0c1b40;
        color: #fff;
    }
</style>

<div class="container-fluid">
    <!-- <spring:message code="vietnamese" var="vietnamese" />
    <spring:message code="chinese" var="chinese" />
    <spring:message code="english" var="english" />
    <spring:message code="profile" var="profile" />
    <spring:message code="logout" var="logout" />

    <jsp:include page="/WEB-INF/jsp/common/header-dashboard.jsp">
        <jsp:param name="titlePage" value="Apollo & Rhea IQC Inspection Report" />
        <jsp:param name="subTitlePage" value="" />
        <jsp:param name="vietnamese" value="<%=pageContext.getAttribute(\"vietnamese\") %>" /> <jsp:param name="chinese"
        value="<%= pageContext.getAttribute(\"chinese\") %>" /> <jsp:param name="english" value="<%=
        pageContext.getAttribute(\"english\") %>" /> <jsp:param name="profile"
        value="<%=pageContext.getAttribute(\"profile\") %>" /> <jsp:param name="logout" value="<%=
        pageContext.getAttribute(\"logout\") %>" />
    </jsp:include> -->

    <div class="container-fluid px-0 content-wrapper">
        <div class="row">
            <div class="col-md-3 component-wrapper">
                <div class="component-item">
                    <h5 class="component-title">Inspected Distribution by Material Type</h5>
                    <div class="component-body chart-box" id="donut-chart-1"></div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="row mb-3">
                    <div class="col-12 d-flex justify-content-between align-items-center">
                        <h5 class="component-title mb-0">Lot Rejected Rate</h5>
                        <select name="sl-option" class="form-select form-select-sm" style="width: auto">
                            <option>Time: Today V</option>
                            <option>Time: Yesterday</option>
                            <option>Time: This Week</option>
                            <option>Time: This Month</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 component-wrapper">
                        <div
                            class="component-item d-flex flex-column justify-content-center align-items-center text-center">
                            <div class="component-title">Inspected</div>
                            <span id="inspected" class="fw-bold text-warning text-span">175</span>
                        </div>
                    </div>

                    <div class="col-md-4 component-wrapper">
                        <div
                            class="component-item d-flex flex-column justify-content-center align-items-center text-center">
                            <div class="component-title">Lot Rejected</div>
                            <span id="lot-rejected" class="fw-bold text-warning text-span">5</span>
                        </div>
                    </div>

                    <div class="col-md-4 component-wrapper">
                        <div
                            class="component-item d-flex flex-column justify-content-center align-items-center text-center">
                            <div class="component-title">LRR</div>
                            <span id="lrr" class="fw-bold text-warning text-span">2.86%</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 component-wrapper">
                        <div class="component-item">
                            <h5 class="component-title">LLR By Weeks</h5>
                            <div class="component-body chart-box" id="col-chart-1"></div>
                        </div>
                    </div>

                    <div class="col-md-6 component-wrapper">
                        <div class="component-item">
                            <h5 class="component-title">LLR Last 7 Days</h5>
                            <div class="component-body chart-box" id="col-chart-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 2 -->
        <div class="row">
            <div class="col-md-3 component-wrapper">
                <div class="component-item">
                    <h5 class="component-title">CPN Status</h5>

                    <div class="component-body">
                        <div class="row">
                            <div class="col-md-6 component-wrapper">
                                <div
                                    class="component-item d-flex flex-column justify-content-center align-items-center text-center">
                                    <div class="component-title">To Be Inspected</div>
                                    <span id="inspected" class="fw-bold text-warning text-span">3059</span>
                                </div>
                            </div>

                            <div class="col-md-6 component-wrapper">
                                <div
                                    class="component-item d-flex flex-column justify-content-center align-items-center text-center">
                                    <div class="component-title">Timeout Inspected</div>
                                    <span id="lot-rejected" class="fw-bold text-warning text-span">700</span>
                                </div>
                            </div>

                            <div class="col-md-6 component-wrapper">
                                <div
                                    class="component-item d-flex flex-column justify-content-center align-items-center text-center">
                                    <div class="component-title">To Be Scanned</div>
                                    <span id="lrr" class="fw-bold text-warning text-span">2110</span>
                                </div>
                            </div>

                            <div class="col-md-6 component-wrapper">
                                <div
                                    class="component-item d-flex flex-column justify-content-center align-items-center text-center">
                                    <div class="component-title">Timeout Scanned</div>
                                    <span id="lrr" class="fw-bold text-warning text-span">1024</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h5 class="component-title mt-3">NCMR Status</h5>
                    <div class="component-body chart-box" id="donut-chart-2"></div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="row">
                    <div class="col-md-4 component-wrapper">
                        <div class="component-item">
                            <h5 class="component-title">Lot Rejected By Material Type</h5>
                            <div class="component-body chart-box" id="col-chart-3"></div>
                        </div>
                    </div>

                    <div class="col-md-4 component-wrapper">
                        <div class="component-item">
                            <h5 class="component-title">Top Lot Rejected By MFR</h5>
                            <div class="component-body chart-box" id="col-chart-4"></div>
                        </div>
                    </div>

                    <div class="col-md-4 component-wrapper">
                        <div class="component-item">
                            <h5 class="component-title">Top Lot Rejected By Models</h5>
                            <div class="component-body chart-box" id="col-chart-5"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 component-wrapper">
                        <div class="component-item">
                            <h5 class="component-title">Lot Rejected By Material Type Details</h5>
                            <div class="component-body table-box">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped" id="table-1">
                                        <thead></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 component-wrapper">
                        <div class="component-item">
                            <h5 class="component-title">Top Lot Rejected By MFR Details</h5>
                            <div class="component-body table-box">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped" id="table-2">
                                        <thead></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 component-wrapper">
                        <div class="component-item">
                            <h5 class="component-title">Top Lot Rejected By Models Details</h5>
                            <div class="component-body table-box">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped" id="table-3">
                                        <thead></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ROW 3 -->
        <div class="row">
            <div class="col-md-6 component-wrapper">
                <div class="component-item">
                    <h5 class="component-title">NCMR List</h5>
                    <div class="component-body table-box" id="table-4">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped" id="table-4">
                                <thead>
                                    <tr>
                                        <th>NCMR_NO</th>
                                        <th>DOC_NO</th>
                                        <th>CASE_OWNER</th>
                                        <th>DEPARTMENT</th>
                                        <th>Title</th>
                                        <th>INSPECTION_I</th>
                                        <th>REJECT_REASON</th>
                                        <th>IMPROVEMENT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>NCMR2511<br />0610525601</td>
                                        <td>251106105256</td>
                                        <td>TRAN THI HUE<br />(31464)</td>
                                        <td>IQC</td>
                                        <td>Cell Texts</td>
                                        <td>2025-11-06</td>
                                        <td>Cosmetic issue: NG NGOAI QUAN BON G KEO</td>
                                        <td>N/A</td>
                                    </tr>

                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>

                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 component-wrapper">
                <div class="component-item">
                    <h5 class="component-title">Inspection List</h5>
                    <div class="component-body table-box" id="table-5">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped" id="table-5">
                                <thead>
                                    <tr>
                                        <th>NCMR_NO</th>
                                        <th>DOC_NO</th>
                                        <th>CASE_OWNER</th>
                                        <th>DEPARTMENT</th>
                                        <th>Title</th>
                                        <th>INSPECTION_I</th>
                                        <th>REJECT_REASON</th>
                                        <th>IMPROVEMENT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>NCMR2511<br />0610525601</td>
                                        <td>251106105256</td>
                                        <td>TRAN THI HUE<br />(31464)</td>
                                        <td>IQC</td>
                                        <td>Cell Texts</td>
                                        <td>2025-11-06</td>
                                        <td>Cosmetic issue: NG NGOAI QUAN BON G KEO</td>
                                        <td>N/A</td>
                                    </tr>

                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>

                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                    <tr>
                                        <td>Cell Text</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                        <td>Cell Texts</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // === DATA CONFIGURATION ===
    const CHART_DATA = {
        materialDistribution: {
            container: "donut-chart-1",
            data: [
                {name: "PCB", y: 564, color: "#9999ff"},
                {name: "ACTIVE", y: 762, color: "#ff9999"},
                {name: "CONNECTOR", y: 415, color: "#66cccc"},
                {name: "E-MECHANICAL", y: 591, color: "#ffcc66"},
                {name: "MECHANICAL", y: 447, color: "#6699ff"},
                {name: "PASSIVE", y: 280, color: "#66cc99"},
            ],
            total: 3059,
        },
        ncmrStatus: {
            container: "donut-chart-2",
            data: [
                {name: "Red", y: 10},
                {name: "Blue", y: 20},
                {name: "Green", y: 70},
            ],
        },
        weeklyData: {
            container: "col-chart-1",
            categories: [
                "2025 W35",
                "2025 W36",
                "2025 W37",
                "2025 W38",
                "2025 W39",
                "2025 W40",
                "2025 W41",
                "2025 W42",
            ],
            inspected: [5000, 5200, 8000, 7500, 4200, 6100, 5300, 7800],
            rejected: [3000, 2900, 3200, 7150, 6700, 3300, 5400, 3200],
            rejectRate: [12, 18, 15, 20, 13, 16, 11, 19],
        },
        dailyData: {
            container: "col-chart-2",
            categories: ["11/7", "11/8", "11/9", "11/10", "11/11", "11/12", "11/13"],
            inspected: [4800, 5100, 4900, 5300, 5000, 4700, 5200],
            rejected: [2800, 3100, 2900, 3300, 3000, 2700, 3200],
            rejectRate: [14, 16, 15, 17, 15, 14, 16],
        },
        materialRejected: {
            container: "col-chart-3",
            name: "Material Type",
            categories: ["MECHANICAL", "PASSIVE", "E-MECHANICAL", "ADAPTER", "ACTIVE"],
            data: [16, 15, 13, 10, 8],
        },
        mfrRejected: {
            container: "col-chart-4",
            name: "MFR",
            categories: ["YAGEO", "MURATA", "VISHAY", "KEMET", "TDK"],
            data: [18, 14, 12, 9, 7],
        },
        modelRejected: {
            container: "col-chart-5",
            name: "Models",
            categories: ["Model A", "Model B", "Model C", "Model D", "Model E"],
            data: [15, 13, 11, 9, 7],
        },
    };

    // === UTILITY FUNCTIONS ===
    const calculateScale = (maxValue) => {
        if (!maxValue || maxValue <= 0) return {max: 10, tickInterval: 2};
        if (maxValue <= 20) return {max: Math.ceil(maxValue / 4) * 4, tickInterval: 4};
        if (maxValue <= 100) return {max: Math.ceil(maxValue / 10) * 10, tickInterval: 10};
        if (maxValue <= 1000) return {max: Math.ceil(maxValue / 100) * 100, tickInterval: 100};
        if (maxValue <= 5000) return {max: Math.ceil(maxValue / 500) * 500, tickInterval: 500};
        return {max: Math.ceil(maxValue / 1000) * 1000, tickInterval: 1000};
    };

    const calculateTotal = (data) => data.reduce((sum, point) => sum + point.y, 0);

    const formatNumber = (value, decimals = 0, suffix = "") =>
        `${Highcharts.numberFormat(Math.abs(value), decimals)}${suffix}`;

    // === CHART CONFIGURATION BUILDERS ===
    const createDonutConfig = (data, total) => ({
        chart: {
            type: "pie",
            height: "100%",
            width: null,
            // Dùng gần hết chiều cao chart-box: ít khoảng trắng trên/dưới
            spacingTop: 10,
            spacingBottom: 30,
            spacingLeft: 10,
            spacingRight: 10,
        },
        tooltip: {pointFormat: "{point.name}: <b>{point.y}</b> ({point.percentage:.2f}%)"},
        legend: {
            enabled: true,
            layout: "horizontal",
            align: "center",
            verticalAlign: "bottom",
            itemStyle: {color: "#7a95c3", fontSize: "0.85rem"},
            symbolRadius: 6,
            symbolHeight: 10,
            symbolWidth: 10,
            itemMarginTop: 5,
            itemMarginRight: 16,
            itemMarginBottom: 5,
            y: -5,
        },
        plotOptions: {
            pie: {
                innerSize: "52%",
                // Mở rộng pie để chiếm nhiều chiều cao hơn nhưng vẫn đủ chỗ cho legend
                size: "78%",
                dataLabels: {
                    enabled: true,
                    format: "{point.name}<br>{point.y} ({point.percentage:.1f}%)",
                    // Đưa label ra ngoài nhưng không quá xa để tránh kéo dài chart
                    distance: 30,
                    connectorWidth: 1,
                    connectorColor: "#7a95c3",
                    style: {
                        fontWeight: "normal",
                        color: "#7a95c3",
                        fontSize: "0.85rem",
                        textOutline: "none",
                    },
                    connectorPadding: 6,
                },
                showInLegend: true,
            },
        },
        series: [{colorByPoint: true, data}],
    });

    const createMirrorConfig = (categories, inspected, rejected, rejectRate) => {
        const mirroredRate = rejectRate.map((rate) => -rate);
        const topScale = calculateScale(Math.max(...inspected, ...rejected));
        const rateScale = calculateScale(Math.max(...rejectRate));

        return {
            xAxis: {categories},
            yAxis: [
                {top: "0%", height: "58%", max: topScale.max, tickInterval: topScale.tickInterval},
                {
                    top: "64%",
                    height: "32%",
                    min: -rateScale.max,
                    max: 0,
                    tickInterval: rateScale.tickInterval,
                    labels: {
                        formatter: function () {
                            return `${Math.abs(this.value)}%`;
                        },
                    },
                    plotLines: [{value: 0, color: "#a0a0a0", width: 1, zIndex: 5}],
                },
            ],
            tooltip: {shared: true, formatter: createMirrorTooltipFormatter()},
            plotOptions: {
                column: {borderRadius: 3, pointPadding: 0.15, groupPadding: 0.1, dataLabels: {enabled: false}},
                series: {states: {inactive: {opacity: 1}}},
            },
            series: [
                {name: "Inspected", type: "column", data: inspected, color: "rgba(153, 153, 255, 0.9)"},
                {
                    name: "Rejected",
                    type: "spline",
                    data: rejected,
                    color: "#ff4d4f",
                    marker: {symbol: "circle", radius: 4},
                },
                {
                    name: "LRR",
                    type: "column",
                    data: mirroredRate,
                    yAxis: 1,
                    color: "rgba(255, 158, 158, 0.9)",
                    isRate: true,
                    dataLabels: {
                        enabled: true,
                        inside: false,
                        formatter: function () {
                            return formatNumber(this.y, 0, "%");
                        },
                    },
                },
            ],
        };
    };

    const createColumnConfig = (categories, data, name) => {
        const scale = calculateScale(Math.max(...data));
        return {
            chart: {type: "column"},
            xAxis: {categories, labels: {autoRotation: [-45]}},
            yAxis: {max: scale.max, tickInterval: scale.tickInterval},
            legend: {enabled: false},
            tooltip: {headerFormat: "<b>{point.x}</b><br/>", pointFormat: "{series.name}: {point.y}"},
            plotOptions: {
                column: {
                    color: "rgba(153, 153, 255, 0.8)",
                    dataLabels: {enabled: true, style: {fontSize: "1rem", fontWeight: "normal"}},
                },
            },
            series: [{name: name || "Value", data}],
        };
    };

    // === TOOLTIP FORMATTERS ===
    const createMirrorTooltipFormatter = () =>
        function () {
            if (!this.points) return "";
            const header = `<span style="font-weight:600">${this.x}</span>`;
            const body = this.points
                .map((point) => {
                    const isRate = point.series.userOptions.isRate;
                    const value = isRate ? formatNumber(point.y, 0, "%") : formatNumber(point.y, 0, "", ",");
                    return `<br/><span style="color:${point.color}">●</span> ${point.series.name}: ${value}`;
                })
                .join("");
            return header + body;
        };

    // === CHART RENDERERS ===
    const renderDonutChart = ({container, data, total}) => {
        const totalValue = total || calculateTotal(data);
        const config = createDonutConfig(data, totalValue);

        Highcharts.chart(container, config, function (chart) {
            addCenterLabel(chart, totalValue);
        });
    };

    const addCenterLabel = (chart, totalValue) => {
        const {plotLeft, plotTop, renderer} = chart;
        const series = chart.series[0];
        const centerX = plotLeft + series.center[0];
        const centerY = plotTop + series.center[1];

        renderer
            .text(`${Highcharts.numberFormat(totalValue, 0, "", ",")}`, centerX, centerY)
            .css({
                color: "#333",
                fontSize: "28px",
                fontWeight: "bold",
                textAnchor: "middle",
            })
            .attr({
                align: "center",
            })
            .add();
    };

    const renderMirrorChart = ({container, categories, inspected, rejected, rejectRate}) => {
        const config = createMirrorConfig(categories, inspected, rejected, rejectRate);
        Highcharts.chart(container, {...config, legend: {align: "center", verticalAlign: "top"}});
    };

    const renderColumnChart = ({container, categories, data, name}) => {
        const config = createColumnConfig(categories, data, name);
        Highcharts.chart(container, config);
    };

    // === INITIALIZATION ===
    const initializeDashboard = () => {
        initializeHighcharts();
        renderAllCharts();
    };

    const renderAllCharts = () => {
        // Donut charts
        renderDonutChart(CHART_DATA.materialDistribution);
        renderDonutChart(CHART_DATA.ncmrStatus);

        // Mirror charts
        renderMirrorChart(CHART_DATA.weeklyData);
        renderMirrorChart(CHART_DATA.dailyData);

        // Column charts
        renderColumnChart(CHART_DATA.materialRejected);
        renderColumnChart(CHART_DATA.mfrRejected);
        renderColumnChart(CHART_DATA.modelRejected);
    };

    // === HIGHCHARTS INITIALIZATION ===
    const initializeHighcharts = () => {
        Highcharts.setOptions({
            chart: {backgroundColor: "transparent", spacing: [10, 5, 5, 5]},
            title: {text: null},
            credits: {enabled: false},
            legend: {itemStyle: {color: "#7a95c3", fontWeight: "600"}, symbolRadius: 0},
            xAxis: {
                gridLineColor: "#313f62",
                gridLineDashStyle: "Dash",
                lineColor: "#313f62",
                labels: {style: {fontSize: "1rem", fontWeight: "600", color: "#7a95c3"}},
            },
            yAxis: {
                gridLineColor: "#313f62",
                gridLineDashStyle: "Dash",
                title: {text: null},
                labels: {style: {fontSize: "1rem", fontWeight: "600", color: "#7a95c3"}},
            },
            tooltip: {outside: true, style: {fontSize: "1rem"}},
            plotOptions: {
                series: {
                    borderWidth: 0,
                    dataLabels: {
                        enabled: true,
                        style: {color: "#fff", textOutline: 0, fontWeight: "normal", fontSize: "1rem"},
                    },
                },
            },
        });
    };

    // === EVENT LISTENER ===
    document.addEventListener("DOMContentLoaded", initializeDashboard);
</script>
